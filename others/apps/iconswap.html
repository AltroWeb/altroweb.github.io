<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Icon Studio v3.3</title>
    <style>
        :root {
            --bg-body: #000000;
            --bg-sidebar: #0f0f11;
            --bg-card: #1c1c1e;
            --bg-hover: #2c2c2e;
            --accent: #0A84FF;
            --danger: #FF453A;
            --text-main: #FFFFFF;
            --text-sub: #8E8E93;
            --border: #38383A;
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            --safe-top: env(safe-area-inset-top);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: var(--font-stack);
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        .app-shell { display: flex; width: 100%; height: 100%; }
        .sidebar { width: 340px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; }
        .main-panel { flex: 1; background: var(--bg-body); display: flex; flex-direction: column; position: relative; z-index: 5; }

        .toolbar {
            height: calc(56px + var(--safe-top)); padding-top: var(--safe-top);
            display: flex; align-items: center; justify-content: space-between; padding-left: 16px; padding-right: 16px;
            border-bottom: 1px solid var(--border); background: rgba(28,28,30, 0.95); backdrop-filter: blur(20px);
        }
        .title { font-weight: 700; font-size: 16px; }
        .btn-icon { background: none; border: none; color: var(--accent); padding: 8px; cursor: pointer; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background: var(--bg-hover); }

        .tab-bar { display: flex; padding: 10px 16px; gap: 10px; border-bottom: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 8px; font-size: 13px; font-weight: 600; background: var(--bg-card); border-radius: 8px; color: var(--text-sub); cursor: pointer; text-align: center; }
        .tab-btn.active { background: var(--bg-hover); color: var(--text-main); }

        .scroll-area { flex: 1; overflow-y: auto; padding: 16px; }
        .list-item { display: flex; align-items: center; padding: 10px; background: var(--bg-card); border-radius: 12px; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent; }
        .list-item.selected { border-color: var(--accent); background: rgba(10, 132, 255, 0.1); }
        .item-icon { width: 42px; height: 42px; border-radius: 10px; background: #333; object-fit: cover; margin-right: 12px; }
        .item-text { flex: 1; min-width: 0; }
        .item-title { font-size: 15px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-sub { font-size: 12px; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .settings-section { display: none; }
        .settings-section.active { display: block; }
        .section-header { font-size: 12px; text-transform: uppercase; color: var(--text-sub); font-weight: 600; margin-bottom: 10px; }
        .setting-card { background: var(--bg-card); border-radius: 12px; padding: 16px; margin-bottom: 20px; }
        
        /* Form Elements */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; float: right;}
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #3a3a3c; border-radius: 34px; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }

        input[type="range"] {
            -webkit-appearance: none; width: 100%; height: 6px; background: #3a3a3c;
            border-radius: 3px; outline: none; margin: 10px 0;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%;
            background: white; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .input-group { margin-bottom: 15px; }
        .input-label { font-size: 12px; color: var(--text-sub); display:block; margin-bottom:5px; font-weight:600;}
        input[type="text"] { width: 100%; background: #000; border: 1px solid var(--border); padding: 12px; border-radius: 8px; color: white; font-size: 14px; }
        .file-upload-btn { display: block; width: 100%; padding: 12px; background: var(--bg-hover); color: white; text-align: center; border-radius: 8px; cursor: pointer; font-size: 14px; border: 1px dashed var(--border); }

        .editor-container { width: 100%; max-width: 400px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; padding-top: 40px; }
        .preview-large { width: 100px; height: 100px; border-radius: 22px; background: #333; object-fit: cover; margin-bottom: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        .btn-full { width: 100%; padding: 14px; border-radius: 12px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-danger { background: rgba(255,69,58,0.15); color: var(--danger); }
        .btn-cancel { background: var(--bg-hover); color: white; }
        .bottom-bar { padding: 16px; border-top: 1px solid var(--border); background: rgba(28,28,30,0.95); }
        .toast { position: fixed; bottom: 40px; left: 50%; transform: translate(-50%, 50px); background: white; color: black; padding: 12px 24px; border-radius: 30px; font-weight: 600; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 100; }
        .toast.visible { transform: translate(-50%, 0); opacity: 1; }

        /* CUSTOM MODAL */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px); z-index: 2000; display: none;
            align-items: center; justify-content: center;
        }
        .modal-overlay.open { display: flex; }
        .modal-box {
            background: var(--bg-card); width: 90%; max-width: 320px;
            padding: 24px; border-radius: 18px; border: 1px solid var(--border);
            text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 10px; }
        .modal-desc { font-size: 14px; color: var(--text-sub); margin-bottom: 24px; line-height: 1.4; }
        .modal-actions { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; }

        @media (max-width: 768px) {
            .sidebar { width: 100%; }
            .main-panel { position: fixed; inset: 0; transform: translateX(100%); transition: transform 0.3s ease; z-index: 20; }
            .main-panel.active { transform: translateX(0); }
            .desktop-spacer { display: none; }
        }
        .mobile-back { display: none; color: var(--accent); background: none; border: none; font-size: 16px; }
        @media (max-width: 768px) { .mobile-back { display: block; } }
    </style>
</head>
<body>

<div class="app-shell">
    <aside class="sidebar">
        <div class="toolbar">
            <span class="title">Icon Studio</span>
            <div style="display:flex; gap:8px;">
                <button class="btn-icon" onclick="app.importPack()" title="Import">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                </button>
                <button class="btn-icon" onclick="app.exportPack()" title="Export">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                </button>
                <button class="btn-icon" onclick="app.fetchFromSimu()" title="Refresh">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                </button>
                <button class="btn-icon" onclick="app.createNew()" title="Add">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                </button>
            </div>
        </div>

        <div class="tab-bar">
            <div class="tab-btn active" onclick="app.switchTab('icons')" id="tab-icons">App Icons</div>
            <div class="tab-btn" onclick="app.switchTab('settings')" id="tab-settings">Global Settings</div>
        </div>

        <div class="scroll-area">
            <div id="section-icons" class="settings-section active"><div id="app-list"></div></div>
            <div id="section-settings" class="settings-section">
                
                <div class="section-header">Icon Style</div>
                <div class="setting-card">
                    <div class="input-group">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <label class="input-label">Corner Roundness</label>
                            <span id="lbl-roundness" style="font-size:12px; color:var(--text-sub);">16px</span>
                        </div>
                        <input type="range" id="rng-roundness" min="0" max="32" value="16" oninput="app.updateRoundnessLabel()" onchange="app.saveSettings()">
                        <div style="display:flex; justify-content:space-between; font-size:10px; color:var(--text-sub);">
                            <span>Square</span>
                            <span>Circle</span>
                        </div>
                    </div>
                </div>

                <div class="section-header">Appearance</div>
                <div class="setting-card">
                    <div style="overflow:hidden;">
                        <span style="font-size:15px;">Hide App Names</span>
                        <label class="switch"><input type="checkbox" id="toggle-hide-names" onchange="app.saveSettings()"><span class="slider"></span></label>
                    </div>
                </div>
                
                <div class="section-header">Custom Font</div>
                <div class="setting-card">
                    <div class="input-group">
                        <label class="input-label">Google Fonts URL</label>
                        <input type="text" id="inp-font-url" placeholder="https://fonts.googleapis.com/css2?..." onchange="app.saveSettings()">
                    </div>
                    <div style="text-align:center; margin: 10px 0; font-size:12px; color:var(--text-sub);">- OR -</div>
                    <label class="file-upload-btn">Upload .ttf File<input type="file" id="inp-font-file" accept=".ttf,.otf,.woff2" style="display:none" onchange="app.handleFontFile(this)"></label>
                    <div id="font-file-status" style="font-size:12px; color:var(--success); margin-top:5px; display:none;">File Loaded!</div>
                </div>
                <button class="btn-full btn-danger" onclick="app.clearAllData()">Reset All Data</button>
            </div>
        </div>
        <div class="bottom-bar"><button class="btn-full btn-primary" style="margin:0" onclick="app.injectToSimu()">Apply Changes</button></div>
    </aside>

    <main class="main-panel" id="main-panel">
        <div class="toolbar">
            <button class="mobile-back" onclick="app.closeEditor()">Back</button>
            <span class="title desktop-spacer">Editor</span>
            <div style="width:40px;"></div>
        </div>
        <div class="scroll-area" style="display:flex; justify-content:center;">
            <div id="editor-form" class="editor-container" style="display:none;">
                <img id="preview-img" class="preview-large" src="">
                <div class="input-group"><label class="input-label">App ID / Name</label><input type="text" id="inp-id"></div>
                <div class="input-group"><label class="input-label">Icon URL</label><input type="text" id="inp-url" oninput="app.updatePreview(this.value)"></div>
                <button class="btn-full btn-primary" onclick="app.saveCurrent()">Save Icon</button>
                <button class="btn-full btn-danger" onclick="app.askDelete()">Delete Icon</button>
            </div>
            <div id="empty-state" style="text-align:center; color:var(--text-sub); margin-top:100px;">
                <div style="font-size:48px; margin-bottom:10px;">ðŸŽ¨</div>
                <h3>Select an App</h3>
            </div>
        </div>
    </main>
</div>

<!-- CONFIRMATION MODAL -->
<div class="modal-overlay" id="confirm-modal">
    <div class="modal-box">
        <div class="modal-title" id="modal-title">Confirm</div>
        <div class="modal-desc" id="modal-desc">Are you sure?</div>
        <div class="modal-actions">
            <button class="modal-btn btn-cancel" onclick="app.hideModal()">Cancel</button>
            <button class="modal-btn btn-danger" id="modal-confirm-btn">Confirm</button>
        </div>
    </div>
</div>

<div class="toast" id="toast">Message</div>
<input type="file" id="import-input" style="display:none" accept=".json" onchange="app.handleImport(this)">

<script>
    class IconStudioV3 {
        constructor() {
            this.icons = JSON.parse(localStorage.getItem('studio_data') || '[]');
            this.settings = JSON.parse(localStorage.getItem('studio_settings') || '{"hideNames": false, "fontUrl": "", "fontData": "", "roundness": 16}');
            if (this.settings.roundness === undefined) this.settings.roundness = 16;
            this.currentIndex = null;
            this.initSettingsUI();
            this.renderList();
            setTimeout(() => this.fetchFromSimu(true), 500);
        }

        switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`section-${tab}`).classList.add('active');
        }

        initSettingsUI() {
            document.getElementById('toggle-hide-names').checked = this.settings.hideNames;
            document.getElementById('inp-font-url').value = this.settings.fontUrl || '';
            document.getElementById('rng-roundness').value = this.settings.roundness;
            this.updateRoundnessLabel();
            if (this.settings.fontData) {
                document.getElementById('font-file-status').style.display = 'block';
                document.getElementById('font-file-status').innerText = 'Custom font loaded';
            }
        }

        updateRoundnessLabel() {
            const val = document.getElementById('rng-roundness').value;
            document.getElementById('lbl-roundness').innerText = val + 'px';
        }

        renderList() {
            const list = document.getElementById('app-list');
            list.innerHTML = '';
            if (this.icons.length === 0) { list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-sub); font-size:13px;">No icons found.</div>`; return; }
            this.icons.forEach((icon, idx) => {
                const item = document.createElement('div');
                item.className = `list-item ${this.currentIndex === idx ? 'selected' : ''}`;
                item.onclick = () => this.select(idx);
                item.innerHTML = `
                    <img class="item-icon" src="${icon.url}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDIiIGhlaWdodD0iNDIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjQyIiBoZWlnaHQ9IjQyIiBmaWxsPSIjMzMzIi8+PC9zdmc+'">
                    <div class="item-text"><div class="item-title">${icon.id || 'Untitled'}</div><div class="item-sub">${icon.url}</div></div>
                `;
                list.appendChild(item);
            });
        }

        select(idx) {
            this.currentIndex = idx;
            const data = this.icons[idx];
            document.getElementById('inp-id').value = data.id;
            document.getElementById('inp-url').value = data.url;
            this.updatePreview(data.url);
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('editor-form').style.display = 'block';
            document.getElementById('main-panel').classList.add('active');
            this.renderList();
        }

        closeEditor() {
            document.getElementById('main-panel').classList.remove('active');
            setTimeout(() => { this.currentIndex = null; this.renderList(); }, 300);
        }

        createNew() { this.icons.unshift({ id: '', url: '' }); this.select(0); }
        updatePreview(url) { document.getElementById('preview-img').src = url; }
        
        saveCurrent() {
            if (this.currentIndex === null) return;
            const id = document.getElementById('inp-id').value.trim();
            if (!id) return this.showToast('ID Required');
            this.icons[this.currentIndex] = { id, url: document.getElementById('inp-url').value.trim() };
            this.saveData(); this.renderList(); this.showToast('Icon Saved');
        }
        
        // --- FIXED MODAL LOGIC ---
        askDelete() {
            if (this.currentIndex === null) return;
            this.showConfirm("Delete Icon", "Are you sure you want to delete this icon? This cannot be undone.", () => {
                this.icons.splice(this.currentIndex, 1);
                this.currentIndex = null;
                this.saveData(); this.renderList(); this.closeEditor();
                document.getElementById('editor-form').style.display = 'none';
                document.getElementById('empty-state').style.display = 'block';
                this.showToast('Deleted');
            });
        }

        saveSettings() {
            this.settings.hideNames = document.getElementById('toggle-hide-names').checked;
            this.settings.fontUrl = document.getElementById('inp-font-url').value.trim();
            this.settings.roundness = document.getElementById('rng-roundness').value;
            this.saveData(); this.showToast('Settings Saved');
        }
        handleFontFile(input) {
            const file = input.files[0];
            if (!file) return;
            document.getElementById('inp-font-url').value = ''; this.settings.fontUrl = '';
            const reader = new FileReader();
            reader.onload = (e) => {
                this.settings.fontData = e.target.result;
                this.saveData();
                document.getElementById('font-file-status').style.display = 'block';
                document.getElementById('font-file-status').innerText = 'Custom font loaded';
                this.showToast('Font File Loaded');
            };
            reader.readAsDataURL(file);
        }
        
        clearAllData() {
            this.showConfirm("Reset Everything", "This will wipe all icons and settings. Are you sure?", () => {
                localStorage.removeItem('studio_data');
                localStorage.removeItem('studio_settings');
                location.reload();
            });
        }
        
        saveData() {
            localStorage.setItem('studio_data', JSON.stringify(this.icons));
            localStorage.setItem('studio_settings', JSON.stringify(this.settings));
        }

        // --- CUSTOM MODAL ---
        showConfirm(title, desc, action) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-desc').innerText = desc;
            const btn = document.getElementById('modal-confirm-btn');
            
            // Remove old listeners
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.onclick = () => {
                action();
                this.hideModal();
            };
            document.getElementById('confirm-modal').classList.add('open');
        }
        hideModal() { document.getElementById('confirm-modal').classList.remove('open'); }


        // EXPORT / IMPORT
        exportPack() {
            const pack = { version: 3.2, icons: this.icons, settings: this.settings };
            const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(pack));
            const node = document.createElement('a');
            node.setAttribute("href", str);
            node.setAttribute("download", "ios_simu_pack.json");
            document.body.appendChild(node); node.click(); node.remove();
        }
        importPack() { document.getElementById('import-input').click(); }
        handleImport(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.icons) this.icons = data.icons;
                    if(data.settings) this.settings = data.settings;
                    this.saveData(); this.initSettingsUI(); this.renderList();
                    this.showToast('Pack Imported!');
                } catch(e) { alert("Invalid Pack"); }
            }
            reader.readAsText(file); input.value = '';
        }

        // SIMULATOR COMMS
        fetchFromSimu(silent = false) {
            try {
                if (window.parent === window) throw new Error("Not embedded");
                const parentDoc = window.parent.document;
                const apps = [];
                const seen = new Set();
                parentDoc.querySelectorAll('.app-item').forEach(el => {
                    const name = el.querySelector('.app-name')?.innerText.trim();
                    const id = el.getAttribute('data-app-id') || el.getAttribute('data-app') || name;
                    const img = el.querySelector('img')?.src;
                    if (id && !seen.has(id)) { seen.add(id); apps.push({ id, url: img || '' }); }
                });
                if (apps.length > 0) {
                    apps.forEach(a => { if (!this.icons.find(i => i.id === a.id)) this.icons.push(a); });
                    this.saveData(); this.renderList();
                    if(!silent) this.showToast(`Fetched ${apps.length} apps`);
                }
            } catch(e) { if(!silent) this.showToast('Fetch Failed'); }
        }

        injectToSimu() {
            try {
                if (window.parent === window) throw new Error("Not embedded");
                const iconMap = {};
                this.icons.forEach(i => { if(i.id && i.url) iconMap[i.id] = i.url; });
                
                window.parent.localStorage.setItem('ios_custom_icons', JSON.stringify(iconMap));
                
                let css = '';
                if (this.settings.roundness !== undefined) {
                    css += `.app-icon { border-radius: ${this.settings.roundness}px !important; } `;
                }
                if (this.settings.hideNames) css += `.homescreen-group .app-name, .dock-container .app-name { display: none !important; } `;
                let fontName = '';
                if (this.settings.fontData) {
                    css += `@font-face { font-family: 'SimCustom'; src: url('${this.settings.fontData}'); } `;
                    fontName = "'SimCustom'";
                } else if (this.settings.fontUrl) {
                    const linkId = 'sim-custom-font-link';
                    let link = window.parent.document.getElementById(linkId);
                    if (!link) {
                        link = window.parent.document.createElement('link');
                        link.id = linkId; link.rel = 'stylesheet';
                        window.parent.document.head.appendChild(link);
                    }
                    link.href = this.settings.fontUrl;
                    fontName = "inherit"; 
                }
                if (fontName || this.settings.fontUrl) {
                    css += `body, .app-name, .nav-title, .store-name, .ios-row { font-family: ${fontName ? fontName + ', ' : ''} -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif !important; }`;
                }
                window.parent.localStorage.setItem('ios_compiled_css', css);

                this.showToast('Applying...');
                setTimeout(() => window.parent.location.reload(), 1000);
            } catch (e) { alert("Injection Failed"); }
        }
        showToast(msg) {
            const t = document.getElementById('toast'); t.innerText = msg;
            t.classList.add('visible'); setTimeout(() => t.classList.remove('visible'), 2000);
        }
    }
    const app = new IconStudioV3();
</script>
</body>
</html>