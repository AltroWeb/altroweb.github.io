<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wallpapers</title>
    <link href="https://fonts.cdnfonts.com/css/sf-pro-display" rel="stylesheet">
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1C1C1E;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --accent: #007AFF;
            --radius: 12px;
        }
        
        * { box-sizing: border-box; }

        body {
            font-family: 'SF Pro Display', -apple-system, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-color); color: var(--text-primary);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            user-select: none; -webkit-user-select: none;
        }

        header {
            padding: 60px 20px 15px 20px;
            background: rgba(28, 28, 30, 0.9); backdrop-filter: blur(20px);
            position: sticky; top: 0; z-index: 10;
            border-bottom: 0.5px solid rgba(255,255,255,0.1);
        }
        h1 { margin: 0; font-size: 34px; font-weight: 700; }

        .scroll-container { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
        .section-title { font-size: 20px; font-weight: 600; margin-bottom: 15px; margin-top: 10px; }
        
        /* Dynamic Preview */
        .preview-box {
            width: 100%; aspect-ratio: 16/9; background-color: var(--card-bg);
            border-radius: var(--radius); margin-bottom: 30px; position: relative;
            overflow: hidden; border: 2px dashed #333;
            display: flex; align-items: center; justify-content: center;
        }
        .preview-box.has-image { border: none; }
        .preview-img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .preview-placeholder { color: var(--text-secondary); pointer-events: none; }

        .input-group { background: var(--card-bg); border-radius: var(--radius); padding: 15px; margin-bottom: 30px; }
        .url-input {
            width: 100%; background: rgba(118, 118, 128, 0.24); border: none; padding: 12px;
            border-radius: 10px; color: white; font-size: 17px; outline: none; margin-bottom: 10px;
            font-family: inherit;
        }
        .btn-row { display: flex; gap: 10px; }
        .btn {
            flex: 1; padding: 12px; border-radius: 10px; border: none;
            font-size: 15px; font-weight: 600; cursor: pointer; font-family: inherit;
        }
        .btn-upload { background: rgba(118, 118, 128, 0.24); color: var(--accent); }
        .btn-load { background: var(--accent); color: white; flex: 0 0 80px; }

        /* Responsive Grid */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); 
            gap: 15px; 
        }
        .wall-item {
            aspect-ratio: 9/19.5; background: #333; border-radius: var(--radius);
            overflow: hidden; cursor: pointer; transition: transform 0.2s;
        }
        .wall-item:active { transform: scale(0.96); }
        .wall-img { width: 100%; height: 100%; object-fit: cover; }

        .action-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; padding: 20px;
            background: linear-gradient(to top, black 50%, transparent);
            display: flex; justify-content: center; pointer-events: none;
        }
        .set-btn {
            background: white; color: black; font-size: 17px; font-weight: 600;
            padding: 16px 40px; border-radius: 30px; border: none;
            box-shadow: 0 4px 20px rgba(255,255,255,0.15); cursor: pointer;
            pointer-events: auto; opacity: 0.5; transition: opacity 0.2s;
            font-family: inherit;
        }
        .set-btn.active { opacity: 1; }
        #file-input { display: none; }
        
        .success-toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 20px 30px;
            border-radius: 16px; color: black; font-weight: 600; opacity: 0; pointer-events: none;
            transition: all 0.3s; z-index: 100; display: flex; flex-direction: column; align-items: center;
        }
        .success-toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    </style>
</head>
<body>
    <header><h1>Wallpapers</h1></header>
    <div class="scroll-container">
        <div class="section-title">Preview</div>
        <div class="preview-box" id="preview-box">
            <span class="preview-placeholder">Select or Upload Image</span>
            <img id="preview-img" class="preview-img">
        </div>
        <div class="input-group">
            <input type="text" class="url-input" id="url-input" placeholder="Paste Image URL...">
            <div class="btn-row">
                <button class="btn btn-upload" onclick="document.getElementById('file-input').click()">Upload Photo</button>
                <button class="btn btn-load" onclick="loadFromUrl()">Go</button>
            </div>
            <input type="file" id="file-input" accept="image/*" onchange="handleFileUpload(this)">
        </div>
        <div class="section-title">Collections</div>
        <div class="grid">
            <div class="wall-item" onclick="selectWallpaper('https://images.unsplash.com/photo-1696429175928-793a1cdef1d3?q=80&w=400')"><img src="https://images.unsplash.com/photo-1696429175928-793a1cdef1d3?q=80&w=200" class="wall-img"></div>
            <div class="wall-item" onclick="selectWallpaper('https://images.unsplash.com/photo-1558591710-4b4a1ae0f04d?q=80&w=400')"><img src="https://images.unsplash.com/photo-1558591710-4b4a1ae0f04d?q=80&w=200" class="wall-img"></div>
            <div class="wall-item" onclick="selectWallpaper('https://images.unsplash.com/photo-1620121692029-d088224ddc74?q=80&w=400')"><img src="https://images.unsplash.com/photo-1620121692029-d088224ddc74?q=80&w=200" class="wall-img"></div>
            <div class="wall-item" onclick="selectWallpaper('https://images.unsplash.com/photo-1605106702734-205df224ecce?q=80&w=400')"><img src="https://images.unsplash.com/photo-1605106702734-205df224ecce?q=80&w=200" class="wall-img"></div>
        </div>
    </div>
    <div class="action-bar"><button class="set-btn" id="set-btn" onclick="applyWallpaper()">Set as Wallpaper</button></div>
    <div class="success-toast" id="toast">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="#34C759"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
        <span>Wallpaper Set</span>
    </div>
    <script>
        let selectedImage = null;
        const setBtn = document.getElementById('set-btn');
        const previewBox = document.getElementById('preview-box');
        const previewImg = document.getElementById('preview-img');

        // Allow only safe image URL schemes for wallpapers.
        function sanitizeImageUrl(raw) {
            if (!raw) return null;
            const value = raw.trim();
            if (!value) return null;

            // Allow data: image/* URLs directly
            if (value.startsWith('data:')) {
                // Basic check to ensure it's an image data URL
                if (/^data:image\//i.test(value)) {
                    return value;
                }
                return null;
            }

            try {
                const url = new URL(value, window.location.origin);
                const allowedProtocols = ['http:', 'https:'];
                if (!allowedProtocols.includes(url.protocol)) {
                    return null;
                }

                // Basic heuristic: only accept URLs that look like image resources.
                // This is intentionally conservative to reduce XSS/abuse risk.
                const pathname = url.pathname || '';
                const imageExtPattern = /\.(?:png|jpe?g|gif|webp|bmp|svg)$/i;
                if (!imageExtPattern.test(pathname)) {
                    return null;
                }

                return url.toString();
            } catch (e) {
                // Invalid URL
                return null;
            }
        }

        function selectWallpaper(url) {
            selectedImage = url; updatePreview();
        }
        function loadFromUrl() {
            const inputEl = document.getElementById('url-input');
            const rawVal = inputEl ? inputEl.value : '';
            const safeUrl = sanitizeImageUrl(rawVal);
            if (safeUrl) {
                selectedImage = safeUrl;
                updatePreview();
            } else if (rawVal && rawVal.trim()) {
                alert('Please enter a valid image URL (http/https or data:image/...).');
            }
        }
        function handleFileUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => { selectedImage = e.target.result; updatePreview(); };
                reader.readAsDataURL(input.files[0]);
            }
            input.value = '';
        }
        function updatePreview() {
            if(selectedImage) {
                previewImg.src = selectedImage; previewImg.style.display = 'block';
                previewBox.classList.add('has-image'); setBtn.classList.add('active');
            }
        }
        function applyWallpaper() {
            if (!selectedImage) return;
            try {
                // 1. Update Current Session
                const parentDoc = window.parent.document;
                const wallpaperEl = parentDoc.getElementById('wallpaper');
                if (wallpaperEl) {
                    // Safely quote and escape the URL when embedding into CSS.
                    const cssSafeUrl = String(selectedImage).replace(/\\/g, '\\\\').replace(/"/g, '\\"');
                    wallpaperEl.style.backgroundImage = 'url("' + cssSafeUrl + '")';

                    // 2. PERMANENT SAVE to Parent Storage
                    window.parent.localStorage.setItem('ios_wallpaper_url', selectedImage);

                    showToast();
                } else {
                    alert("Simulator not found. Are you running this app inside the iOS Simulator?");
                }
            } catch (e) {
                console.error(e);
                alert("Storage Error: Ensure you are running on HTTPS/Same Domain to allow access to parent window.");
            }
        }
        function showToast() {
            const toast = document.getElementById('toast'); toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }
    </script>
</body>
</html>