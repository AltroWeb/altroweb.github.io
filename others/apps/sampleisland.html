<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Music Player</title>
    <style>
        /* --- PRO DARK THEME STYLING --- */
        :root {
            --primary: #fff;
            --secondary: rgba(255,255,255,0.6);
            --bg-gradient: linear-gradient(180deg, #1c1c1e 0%, #000000 100%);
            --accent: #007AFF;
        }

        body {
            margin: 0; padding: 0;
            background: var(--bg-gradient);
            color: var(--primary);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none;
        }

        .player-container { 
            padding: 0 32px; display: flex; flex-direction: column; 
            height: 100%; justify-content: center; position: relative; z-index: 2;
        }

        /* ALBUM ART WITH SHADOW */
        .artwork-container {
            width: 100%; aspect-ratio: 1/1; margin-bottom: 40px; position: relative;
            display: flex; justify-content: center; align-items: center;
        }
        .artwork {
            width: 100%; height: 100%;
            background-image: url('https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?q=80&w=600');
            background-size: cover; background-position: center; border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6); 
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        
        .track-info { margin-bottom: 30px; }
        .track-title { font-size: 24px; font-weight: 700; margin-bottom: 6px; letter-spacing: -0.5px; }
        .track-artist { font-size: 18px; color: var(--secondary); font-weight: 500; }
        
        /* STATUS INDICATOR */
        .status-pill {
            margin-top: 12px; padding: 6px 12px; border-radius: 20px;
            background: rgba(255,255,255,0.08); font-size: 11px; font-weight: 700;
            color: #8E8E93; text-transform: uppercase; letter-spacing: 0.5px;
            width: fit-content; display: flex; align-items: center; gap: 6px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .status-indicator { width: 6px; height: 6px; border-radius: 50%; background-color: #555; transition: background-color 0.3s; }
        .status-pill.active .status-indicator { background-color: #30D158; box-shadow: 0 0 8px #30D158; }
        .status-pill.active { color: #fff; background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.1); }

        /* CONTROLS */
        .controls { display: flex; justify-content: space-between; align-items: center; padding: 0 10px; }
        .btn-control { background: none; border: none; color: white; cursor: pointer; opacity: 1; transition: transform 0.1s, opacity 0.2s; }
        .btn-control:active { transform: scale(0.9); opacity: 0.7; }
        
        /* PROGRESS BAR */
        .progress-container { width: 100%; margin-bottom: 30px; }
        .progress-bar { width: 100%; height: 4px; background: rgba(255,255,255,0.15); border-radius: 2px; overflow: hidden; }
        .progress-fill { width: 35%; height: 100%; background: #fff; border-radius: 2px; }
        .time-labels { display: flex; justify-content: space-between; font-size: 12px; color: var(--secondary); margin-top: 8px; font-weight: 600; }

    </style>
</head>
<body>

    <div class="player-container">
        <div class="artwork-container">
            <div class="artwork" id="album-art"></div>
        </div>
        
        <div class="track-info">
            <div class="track-title">Aggressive Override</div>
            <div class="track-artist">System Controller</div>
            <div id="status" class="status-pill">
                <div class="status-indicator"></div>
                <span id="status-text">Seizing Control...</span>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-bar"><div class="progress-fill"></div></div>
            <div class="time-labels"><span>1:20</span><span>-2:45</span></div>
        </div>

        <div class="controls">
            <button class="btn-control"><svg width="28" height="28" fill="white" viewBox="0 0 24 24"><path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/></svg></button>
            <button class="btn-control"><svg width="64" height="64" fill="white" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg></button>
            <button class="btn-control"><svg width="28" height="28" fill="white" viewBox="0 0 24 24"><path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"/></svg></button>
        </div>
    </div>

    <script>
    (function() {
        // --- CONFIGURATION ---
        const CONFIG = {
            appName: "My Custom Music", // MUST MATCH APP BUILDER NAME EXACTLY
            islandTitle: "Now Playing",
            islandSub: "Pro Audio",
            islandIcon: "https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?q=80&w=100"
        };

        const statusText = document.getElementById('status-text');
        const statusPill = document.getElementById('status');
        let REAL_APP_ID = null;

        // --- 1. ENGINE ACCESS ---
        function getEngine() {
            try {
                if (window.parent === window) return null;
                const iOS = window.parent.eval('iOS'); 
                const doc = window.parent.document;
                return (iOS && doc) ? { iOS, doc } : null;
            } catch (e) { return null; }
        }

        // --- 2. INTELLIGENT ID DISCOVERY & PERSISTENCE ---
        function findRealAppID(parentWindow) {
            try {
                // 1. Try to find ID in installed apps list
                const raw = parentWindow.localStorage.getItem('ios_installed_apps');
                if (raw) {
                    const apps = JSON.parse(raw);
                    const match = apps.find(a => a.name === CONFIG.appName);
                    if (match && match.id) return match.id;
                }
                
                // 2. Fallback: Check if we saved it previously
                const savedID = parentWindow.localStorage.getItem('my_custom_music_id');
                if (savedID) return savedID;

            } catch(e) { return null; }
            return null;
        }

        // --- 3. UI HELPER ---
        function forceIslandText(doc) {
            const title = doc.querySelector('.island-title');
            const sub = doc.querySelector('.island-sub');
            const icon = doc.querySelector('.island-icon');
            
            // Aggressively force text if we are owner
            if (window.parent.eval('iOS')._islandOwner === REAL_APP_ID) {
                if (title) title.innerText = CONFIG.islandTitle;
                if (sub) sub.innerText = CONFIG.islandSub;
                if (icon) icon.style.backgroundImage = `url('${CONFIG.islandIcon}')`;
            }
        }

        // --- 4. MAIN LOGIC ---
        function init() {
            const engine = getEngine();
            if (!engine) {
                statusText.innerText = "Connection Failed";
                return;
            }
            const { iOS, doc } = engine;

            REAL_APP_ID = findRealAppID(window.parent);
            if (!REAL_APP_ID) {
                // Only use name as ID if absolutely necessary (legacy fallback)
                REAL_APP_ID = CONFIG.appName;
                statusText.innerText = "ID Not Found";
            } else {
                // Save ID for persistence across reloads
                window.parent.localStorage.setItem('my_custom_music_id', REAL_APP_ID);
                statusText.innerText = `ID: ${REAL_APP_ID.substring(0,6)}`;
                statusPill.classList.add('active');
            }

            // --- CROSS-DUPLICATE HANDLING ---
            window.parent.localStorage.setItem('last_active_music_id', REAL_APP_ID);

            // Force initial ownership
            iOS._islandOwner = REAL_APP_ID;
            forceIslandText(doc);

            // SAVE ORIGINALS (Safety check)
            if (!iOS._originals) {
                iOS._originals = {
                    launch: iOS.launchMusicFromIsland,
                    toggle: iOS.toggleIsland,
                    close: iOS.closeApp,
                    click: iOS.handleIslandClick
                };
            }

            // =======================================================
            // AGGRESSIVE PROTOCOL: MONITOR & SEIZE
            // =======================================================
            setInterval(() => {
                const lastActiveID = window.parent.localStorage.getItem('last_active_music_id');
                const activeWindowApp = iOS.activeWindow ? iOS.activeWindow.getAttribute('data-app') : null;

                // 1. If user explicitly opened official Music, yield.
                if (activeWindowApp === 'Music') {
                    iOS._islandOwner = 'Music';
                    return; 
                }

                // 2. Otherwise, FORCE ownership to us if we were the last active custom app
                if (lastActiveID === REAL_APP_ID) {
                    iOS._islandOwner = REAL_APP_ID;
                    forceIslandText(doc);
                }

            }, 50); // High frequency check

            // =======================================================
            // OVERRIDE 1: LAUNCH (Aggressive Recede & No-Loop)
            // =======================================================
            iOS.launchMusicFromIsland = function() {
                // Yield only if we really don't own it
                if (iOS._islandOwner !== REAL_APP_ID) return iOS._originals.launch.call(this);

                // Bounce if active
                if (this.activeWindow === this.mainWindow && this.activeWindow.getAttribute('data-app') === REAL_APP_ID) {
                    this.toggleIsland(true);
                    return;
                }

                // 1. AGGRESSIVE RECEDE: Push back WHATEVER is active
                if (this.state === 'ACTIVE' && this.activeWindow) {
                    this.activeWindow.classList.add('receded');
                } else {
                    this.homescreenGroup.classList.add('minimized');
                    this.wallpaper.classList.add('active-app');
                }

                this.state = 'OPENING';
                this.openedFromIsland = true;

                // 2. CLEANUP
                clearTimeout(this.autoCollapseTimer);
                this.toggleIsland(false); 
                this.statusBar.classList.remove('blurred', 'squished', 'dark-text');
                this.gestureBar.classList.remove('on-home', 'dark-bar');

                // 3. TARGET US (Main Window)
                this.activeWindow = this.mainWindow;
                
                // CRITICAL: Only route content if ID has changed to prevent reload loop
                if (this.activeWindow.getAttribute('data-app') !== REAL_APP_ID) {
                    this.routeContent(REAL_APP_ID);
                }
                this.activeWindow.setAttribute('data-app', REAL_APP_ID);

                // 4. WARP ANIMATION
                const islandRect = this.island.getBoundingClientRect();
                const screenRect = this.screen.getBoundingClientRect();
                const dx = ((islandRect.left + islandRect.width/2) - (screenRect.left + screenRect.width/2)) / this.currentScale;
                const dy = ((islandRect.top + islandRect.height/2) - (screenRect.top + screenRect.height/2)) / this.currentScale;

                this.activeWindow.style.display = 'flex';
                this.activeWindow.style.transition = 'none';
                this.activeWindow.style.opacity = '1';
                this.activeWindow.style.transform = `translate3d(${dx}px, ${dy}px, 0) scale(0.25)`;
                this.activeWindow.style.borderRadius = '50px';
                this.activeWindow.style.setProperty('--tx', `${dx}px`);
                this.activeWindow.style.setProperty('--ty', `${dy}px`);
                this.activeWindow.offsetHeight; 
                this.activeWindow.classList.add('launching-timewarp');

                // 5. UNLOCK GESTURES (Force Active State)
                setTimeout(() => {
                    this.island.style.transition = '';
                    if (this.state === 'OPENING') {
                        this.state = 'ACTIVE';
                        this.activeWindow.style.borderRadius = '0px';
                        this.activeWindow.style.transform = 'translate3d(0,0,0) scale(1)';
                        this.activeWindow.classList.remove('launching-timewarp');
                    }
                }, 750);
            };

            // =======================================================
            // OVERRIDE 2: TOGGLE (Bounce)
            // =======================================================
            iOS.toggleIsland = function(forceState) {
                const currentID = this.activeWindow ? this.activeWindow.getAttribute('data-app') : null;
                // If WE are active, always bounce
                if (this.state === 'ACTIVE' && currentID === REAL_APP_ID) {
                    this.island.classList.remove('island-bounce');
                    void this.island.offsetWidth;
                    this.island.classList.add('island-bounce');
                    return;
                }
                return iOS._originals.toggle.call(this, forceState);
            };

            // =======================================================
            // OVERRIDE 3: CLOSE (Vacuum + Reset)
            // =======================================================
            iOS.closeApp = function() {
                if (this.state === 'IDLE' || this.state === 'CLOSING') return;
                
                const currentID = this.activeWindow.getAttribute('data-app');

                // Only Vacuum if it's US AND opened from Island
                if (currentID === REAL_APP_ID && this.openedFromIsland) {
                    this.state = 'CLOSING';

                    // 1. Reset UI
                    this.statusBar.classList.remove('dark-text');
                    this.gestureBar.classList.remove('dark-bar');
                    this.gestureBar.classList.add('on-home');

                    // Reset Receded Elements
                    doc.querySelectorAll('.receded').forEach(el => el.classList.remove('receded'));
                    this.homescreenGroup.classList.remove('minimized');
                    this.wallpaper.classList.remove('active-app');

                    // 2. Vacuum Math
                    const islandRect = this.island.getBoundingClientRect();
                    const screenRect = this.screen.getBoundingClientRect();
                    const dx = ((islandRect.left + islandRect.width/2) - (screenRect.left + screenRect.width/2)) / this.currentScale;
                    let dy = ((islandRect.top + islandRect.height/2) - (screenRect.top + screenRect.height/2)) / this.currentScale;
                    dy += 28; 

                    this.activeWindow.classList.add('vacuum-active');
                    this.activeWindow.style.transform = `translate3d(${dx}px, ${dy}px, 0) scale(0.1)`;
                    this.activeWindow.style.borderRadius = '50px';
                    this.activeWindow.style.opacity = '0';

                    if (this.activeAppIcon) {
                        this.activeAppIcon.classList.remove('hidden-source');
                        this.activeAppIcon.style.opacity = '1';
                        this.activeAppIcon.style.transform = 'scale(1)';
                    }

                    // 3. Impact & Blur Cleanup
                    setTimeout(() => {
                        this.island.classList.add('compact', 'island-impact');
                        setTimeout(() => this.island.classList.remove('island-impact'), 600);
                        this.statusBar.classList.add('squished');

                        clearTimeout(this.autoCollapseTimer);
                        this.autoCollapseTimer = setTimeout(() => {
                            if (this.islandContent) this.islandContent.classList.add('blur-out');
                            setTimeout(() => {
                                this.island.classList.remove('compact');
                                this.statusBar.classList.remove('squished');
                                setTimeout(() => {
                                    if (this.islandContent) this.islandContent.classList.remove('blur-out');
                                }, 300);
                            }, 200);
                        }, 3000);
                    }, 280);

                    this.openedFromIsland = false;

                    // 4. FORCE CLOSE FINISH
                    setTimeout(() => {
                        if (this.state === 'CLOSING') {
                            this.finishClosing(); 
                            forceIslandText(doc); 
                        }
                    }, 650);

                } else {
                    return iOS._originals.close.call(this);
                }
            };

            // =======================================================
            // OVERRIDE 4: CLICK (Hijack)
            // =======================================================
            iOS.handleIslandClick = function() {
                // If Music owns it (user explicitly opened it), let it be
                if (iOS._islandOwner === 'Music') return iOS._originals.click.call(this);

                // Otherwise, WE force control
                if (this.state === 'ACTIVE' && this.activeWindow && this.activeWindow.getAttribute('data-app') === REAL_APP_ID) {
                    this.toggleIsland(true);
                    return;
                }
                
                // If expanding, launch US
                if (this.isIslandExpanded || this.island.classList.contains('compact')) {
                    this.launchMusicFromIsland();
                } else {
                    iOS._originals.toggle.call(this, true);
                }
            };

            // UNLOAD CLEANUP
            window.addEventListener('unload', () => {
                // If we currently own the island, try to restore defaults for stability
                if (iOS._islandOwner === REAL_APP_ID) {
                    iOS.launchMusicFromIsland = iOS._originals.launch;
                    iOS.toggleIsland = iOS._originals.toggle;
                    iOS.closeApp = iOS._originals.close;
                    iOS.handleIslandClick = iOS._originals.click;
                }
            });
        }

        setTimeout(init, 500);

    })();
    </script>
</body>
</html>